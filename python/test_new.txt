DROP TABLE [ODS].[DBO].[TEM_ARR_ACCOUNT];
DROP TABLE [ODS].[DBO].[TEM_ARR_INTEREST];
DROP TABLE [ODS].[DBO].[TEM_ARR_TERM_AMOUNT];
DROP TABLE [ODS].[DBO].[TEM_ARRANGEMENT];
DROP TABLE [ODS].[DBO].[TEM_AA_BILL_DETAILS];
DROP TABLE [ODS].[DBO].[TEM_AA_BILL_DETAILS_PROPERTY];
DROP TABLE [ODS].[DBO].[TEM_ARR_RENEW_INFO];
DROP TABLE [ODS].[DBO].[TEM_ARRANGEMENT_ACTIVITY];
DROP TABLE [ODS].[DBO].[TEM_ARR_DEPOSIT];
DROP TABLE [ODS].[DBO].[TEM_ARR_CHARGE];
DROP TABLE [ODS].[DBO].[TEM_AA_PROPERTY_DESC];
DROP TABLE [ODS].[dbo].[TEM_QF_H_COLLECT_AC_PARAM];
DROP TABLE [ODS].[DBO].[TEM_STMT_ENTRY];



SELECT * 
INTO [ODS].[DBO].[TEM_ARR_ACCOUNT] FROM (
SELECT T.ARRANGEMENT_KEY,
       T.ID_COMP_1,
       T.ID_COMP_2, 
       T.ID_COMP_3,
       T.ID_COMP_4,
       T.ID_COMP_5,
       T.ID_COMP_6,
	   T.L_CHANNEL_ID, 
       T.L_DAO, 
       A.ALT_ID, 
	   B.ALT_ID as ALT_ID_2,
	   C.ALT_ID as ALT_ID_3,
	   T.L_LIMIT_TYPE ,
	   T.L_NEW_RATE,
	   T.L_PAY_STATUS,
	   T.L_PAY_METHOD,
	   T.L_CHG_OR_NOT,
	   T.L_THIRD_PARTY, 
	   T.L_P2P_PROV,
	   T.L_T2P_PROV,
	   T.L_LOAN_PURPOSE,
	   T.L_MATCH_TYPE,
	   T.L_ONLINE_OR_NOT,
	   T.L_CREDIT_REPO,
	   T.L_SIGN_DATE,
	   T.L_RENEW_LST_AD,
       T.L_RENEW_ORG_AD, 
       T.L_RENEW_FLG, 
       T.L_COLL_PLAN_NO, 
       T.L_TERM_TYPE, 
       T.L_INT_TYPE, 
       T.L_FUND_PAY_WAY, 
       T.L_CD_AC_ID, 
	   T.L_CD_AC_TYPE,
       T.L_CD_AC_OP_BK, 
	   T.L_CD_AC_OP_BK_P,
	   T.L_CD_AC_OP_BK_C,
	   T.L_CD_AC_PHONE,
	   T.L_REPAY_MARK,
	   T.L_LIQ_TYPE ,
	   T.L_CLS_DATE,  
	   L_CD_AC_TITLE,
	   L_APPL_START_DT,
	   L_THIRD_PARTY_S,
	   T.ACCOUNT_REFERENCE, 
	   L_AD_AL_MAPP_F,
       ROW_NUMBER() OVER(PARTITION BY T.ID_COMP_1, T.ID_COMP_2 ORDER BY T.ID_COMP_3 DESC) AS RN,
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
  FROM [TDI].[DBO].[AA_ARR_ACCOUNT] T
  INNER JOIN [TDI].[dbo].[AA_ARR_ACCOUNT_ALT_ID_TYPE] A ON A.SEQ1 = T.SEQ1
                                                              AND A.seq2 = '1'
  INNER JOIN [TDI].[dbo].[AA_ARR_ACCOUNT_ALT_ID_TYPE] B ON B.SEQ1 = T.SEQ1
                                                              AND B.seq2 = '2'
  INNER JOIN [TDI].[dbo].[AA_ARR_ACCOUNT_ALT_ID_TYPE] C ON C.SEQ1 = T.SEQ1
                                                              AND C.seq2 = '3'
  WHERE T.CURRENCY = 'CNY') T WHERE RN = 1;


SELECT *
	   INTO [ODS].[DBO].[TEM_ARR_INTEREST] 
  FROM (SELECT T.ARRANGEMENT_KEY,
       T.ID_COMP_1,
       T.ID_COMP_2,
       T.ID_COMP_3,
       T.ID_COMP_4,
       T.ID_COMP_5,
       T.ID_COMP_6,
	   T.ACTIVITY,
       T.RATE_TIER_TYPE,
	   T.DAY_BASIS,
       A.TIER_MIN_RATE,
	   A.FIXED_RATE,
	   CAST(A.EFFECTIVE_RATE AS FLOAT) AS EFFECTIVE_RATE, 
       ROW_NUMBER() OVER(PARTITION BY T.ID_COMP_1, T.ID_COMP_2 ORDER BY T.ID_COMP_3 DESC) AS RN,
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
  FROM [TDI].[DBO].AA_ARR_INTEREST T
  LEFT JOIN [TDI].[DBO].AA_ARR_INTEREST_FIXED_RATE A
    ON T.SEQ1 = A.SEQ1) T WHERE RN = 1;


SELECT * 
INTO [ODS].[DBO].[TEM_ARR_TERM_AMOUNT]
FROM (SELECT T.ARRANGEMENT_KEY,
       T.ID_COMP_1,
       T.ID_COMP_2,
       T.ID_COMP_3,
       T.ID_COMP_4,
       T.ID_COMP_5,
       T.ID_COMP_6,
       TERM, 
       AMOUNT,
       CASE WHEN MATURITY_DATE = '' THEN NULL ELSE CONVERT(DATE, MATURITY_DATE, 112) END AS MATURITY_DATE, 
       L_INV_CLS_TERM, 
	   L_INV_CLS_DATE,
       ROW_NUMBER() OVER(PARTITION BY T.ID_COMP_1 ORDER BY T.ID_COMP_3 DESC) AS RN,
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
  FROM [TDI].[DBO].[AA_ARR_TERM_AMOUNT] T) T WHERE RN = 1;



SELECT T.ARRANGEMENT_ID,
       A.PRODUCT,
	   T.CUSTOMER,
	   CASE WHEN T.START_DATE = '' THEN NULL ELSE CONVERT(DATE, T.START_DATE, 112) END AS START_DATE,
       B.EFFECTIVE_DATE AS PRODUCT_EFFECTIVE_DATE,
       D.EXPIRY_DATE AS PRODUCT_EXPIRY_DATE,
	   E.AD_CLS_AMT,
	   T.ARR_STATUS,
	   T.CO_CODE, 
	   G.LINKED_APPL,
	   G.LINKED_APPL_ID,
	   F.EFFECTIVE_DATE AS ARR_EFFECTIVE_DATE,
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
	   INTO [ODS].[DBO].[TEM_ARRANGEMENT]
  FROM [TDI].[DBO].[AA_ARRANGEMENT] T
  INNER JOIN [TDI].[DBO].[AA_ARRANGEMENT_PRODUCT] A
    ON T.SEQ1 = A.SEQ1

  INNER JOIN 
   (SELECT M.PRODUCT, M.EFFECTIVE_DATE, 
		   (CASE WHEN N.EXPIRY_DATE = '' OR N.EXPIRY_DATE IS NULL THEN '99991231' 
				 ELSE N.EXPIRY_DATE END) AS EXPIRY_DATE 
   FROM [TDI].[DBO].[AA_PRODUCT_CATALOG] M ,
        [TDI].[DBO].[AA_PRODUCT_MANAGER] N
   WHERE M.PRODUCT = N.PRODUCT_ID) B

    ON A.PRODUCT = B.PRODUCT
   AND T.START_DATE >= B.EFFECTIVE_DATE
   AND T.START_DATE < B.EXPIRY_DATE

  INNER JOIN [TDI].[DBO].[AA_PRODUCT_MANAGER] D
    ON A.PRODUCT = D.PRODUCT_ID
  LEFT JOIN [TDI].[DBO].[QF_H_AD_CLOSURE_INFO] E
    ON T.ARRANGEMENT_ID = E.AD_ID 
  LEFT JOIN (SELECT T.ARRANGEMENT_ID, T.EFFECTIVE_DATE, 
             ROW_NUMBER() OVER(PARTITION BY T.ARRANGEMENT_ID ORDER BY T.SEQ2 ASC) AS RN
 FROM [TDI].[DBO].[AA_ACTIVITY_HISTORY_EFFECTIVE_DATE] T) F
	ON F.ARRANGEMENT_ID = A.ARRANGEMENT_ID AND F.RN = 1  
  LEFT JOIN [TDI].[DBO].AA_ARRANGEMENT_LINKED_APPL G
    ON T.SEQ1 = G.SEQ1 
 WHERE T.CURRENCY = 'CNY';



SELECT A.BILL_REFERENCE,
	   A.ARRANGEMENT_ID,
	   A.PAYMENT_INDICATOR,
	   A.OR_TOTAL_AMOUNT, 
	   A.PAYMENT_DATE, 
	   A.ACTUAL_PAY_DATE, 
	   A.LAST_UPDATE_DATE,
	   B.BILL_ST_CHG_DT, 
	   C.ADV_AMT,
	   C.ADV_PR_AMT,
	   C.ADV_IN_AMT,
	   C.ADV_PE_AMT,
	   G.REF_NO,  
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
	   INTO [ODS].[DBO].[TEM_AA_BILL_DETAILS]
  FROM [TDI].[DBO].[AA_BILL_DETAILS] A
  LEFT JOIN [TDI].[DBO].[AA_BILL_DETAILS_BILL_STATUS] B 
	ON A.SEQ1 = B.SEQ1 AND B.BILL_STATUS = 'SETTLED'
  LEFT JOIN [TDI].[DBO].[QF_H_AL_ADV_REPAY_LOG_BILL_ID] C
	ON A.ARRANGEMENT_ID = C.ID
  
  LEFT JOIN [TDI].[DBO].[AA_BILL_DETAILS_REPAY_REF] E ON A.SEQ1 = E.SEQ1 and E.SEQ2 = 1
  LEFT JOIN [TDI].[DBO].[AA_ARRANGEMENT_ACTIVITY] F ON E.REPAY_REF = F.ARR_SEQUENCE + '-'+ F.EFFECTIVE_DATE
  LEFT JOIN [TDI].[DBO].[FUNDS_TRANSFER] G ON F.TXN_CONTRACT_ID = G.DEBIT_ACCT_NO AND G.TRANSACTION_TYPE = 'ACDP'
  WHERE A.CURRENCY = 'CNY'



SELECT A.BILL_REFERENCE,
	   A.PAYMENT_INDICATOR,
	   A.PAYMENT_DATE,
	   C.REPAY_REF,
	  CASE WHEN C.REPAY_REF='' OR  C.REPAY_REF IS NULL THEN NULL ELSE SUBSTRING(C.REPAY_REF,1,LEN(REPAY_REF)-9)end AS REPAY_REF_NO,
	  CASE WHEN C.REPAY_REF='' OR  C.REPAY_REF IS NULL THEN NULL ELSE RIGHT(REPAY_REF,8) end AS REPAY_REF_DATE,
	  CASE WHEN e.ADJUST_REF='' OR  e.ADJUST_REF IS NULL THEN NULL ELSE SUBSTRING(e.ADJUST_REF,1,LEN(e.ADJUST_REF)-9)end AS ADJUST_REF_NO,
	  CASE WHEN e.ADJUST_REF='' OR  e.ADJUST_REF IS NULL THEN NULL ELSE SUBSTRING(e.ADJUST_REF,1,LEN(e.ADJUST_REF)-9)end AS ADJUST_REF_Date,
	   A.OR_TOTAL_AMOUNT,
	   A.OS_TOTAL_AMOUNT,
       A.ARRANGEMENT_ID,
       B.PROPERTY,
       cast(B.OR_PROP_AMOUNT as float) as OR_PROP_AMOUNT, 
	   cast(B.OS_PROP_AMOUNT as float) as OS_PROP_AMOUNT,
	   C.REPAY_AMOUNT, 
	   E.ADJUST_AMT, 
	   f.BILL_STATUS,
	   f.BILL_ST_CHG_DT,
	   g.BILL_STATUS AS ACCOUNT_BILL_STATUS,
	   g.AGING_STATUS,
	   A.LAST_UPDATE_DATE,
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
	   INTO [ODS].[DBO].[TEM_AA_BILL_DETAILS_PROPERTY]
  FROM [TDI].[DBO].[AA_BILL_DETAILS] A
  LEFT JOIN [TDI].[DBO].[AA_BILL_DETAILS_PROPERTY] B ON A.SEQ1 = B.SEQ1
  LEFT JOIN [TDI].[DBO].[AA_BILL_DETAILS_REPAY_REF] C ON B.SEQ1 = C.SEQ1 and B.SEQ2 = C.SEQ2
  LEFT JOIN [TDI].[DBO].[AA_BILL_DETAILS_ADJUST_REF] E ON B.SEQ1 = E.SEQ1 and B.SEQ2 = E.SEQ2
  INNER JOIN ( SELECT bs.*,ROW_NUMBER()OVER(PARTITION BY BILL_REFERENCE ORDER BY BILL_ST_CHG_DT desc,seQ2) AS RN  
  FROM tdi.dbo.AA_BILL_DETAILS_BILL_STATUS bs)f ON f.BILL_REFERENCE=b.BILL_REFERENCE
  INNER JOIN TDI.DBO.AA_ACCOUNT_DETAILS_BILL_ID g ON g.BILL_ID=b.BILL_REFERENCE
 WHERE A.CURRENCY = 'CNY'
	

 

SELECT T.ID,
	   T.AD_MATURITY_DATE, 
	   T.AD_RENEW_ORG_AD_ID, 
	   T.AD_RENEW_LST_AD_ID, 
       T.AD_RENEW_NEW_AD_ID, 
       T.AD_RENEW_NEW_PRD_ID, 
       T.AD_RENEW_STATUS, 
	   T.AD_RENEW_FLG, 
       T.CO_CODE, 
       T.DEPT_CODE, 
	   CAST(ROW_NUMBER() OVER (PARTITION BY T.AD_RENEW_ORG_AD_ID ORDER BY T.AD_MATURITY_DATE) AS INT) AS RN, 
       CURRENT_TIMESTAMP     AS DW_LAST_UPDATE_TIME
  INTO [ODS].[DBO].[TEM_ARR_RENEW_INFO]
  FROM [TDI].[DBO].QF_H_AD_RENEW_INFO T;



 SELECT A.ID,
        CAST(A.AV_MAPPING_AMT AS FLOAT) AS AV_MAPPING_AMT,
        CAST(A.AD_TOT_REVAL AS FLOAT) AS AD_TOT_REVAL,
        CAST(A.AV_NON_MAPPING_AMT AS FLOAT) AS AV_NON_MAPPING_AMT,
        CAST(A.AD_TOT_PR AS FLOAT) AS AD_TOT_PR,
	    CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
   INTO [ODS].[DBO].[TEM_ARR_DEPOSIT]
   FROM [TDI].[DBO].[QF_H_AA_DEPOSIT] A 



SELECT A.*,
       B.SEQ2,
       B.CALC_TIER_TYPE,
       B.CALC_TYPE,
       B.CHARGE_RATE,
       B.TIER_AMOUNT,
       CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME
  INTO [ODS].[DBO].[TEM_ARR_CHARGE]
  FROM (SELECT A.ARRANGEMENT_KEY,
               A.ACTIVITY,
               A.CHARGE_TYPE,
               A.FIXED_AMOUNT,
			   A.MIN_CHG_AMOUNT,
               A.ID_COMP_1,
               A.ID_COMP_2,
               A.ID_COMP_3,
               A.ID_COMP_4,
               A.ID_COMP_5,
               A.ID_COMP_6,
               ROW_NUMBER() OVER(PARTITION BY A.ID_COMP_1, A.ID_COMP_2 ORDER BY A.ID_COMP_3 DESC) AS RN
          FROM [TDI].[DBO].AA_ARR_CHARGE A
         WHERE A.CURRENCY = 'CNY') A
  LEFT JOIN [TDI].[DBO].AA_ARR_CHARGE_CALC_TIER_TYPE B
    ON B.ARRANGEMENT_KEY = A.ARRANGEMENT_KEY
  WHERE A.RN = 1

 

SELECT  T.ARR_SEQUENCE,
		T.ARRANGEMENT, 
		T.ACTIVITY,
		T.EFFECTIVE_DATE, 
		T.CUSTOMER,
		T.AUTHORISER,
		B.DATE_TIME,
		A.ACTIVITY_REF,
		A.SYSTEM_DATE,
		A.ACTIVITY_AMT,
		T.TXN_CONTRACT_ID,
		C.INPUTTER,
		T.PRODUCT,
		CASE CHARINDEX('NEW-ARRANGEMENT',T.ACTIVITY) WHEN 0 THEN '0' ELSE '1' END AS NEW_IDX,
	    CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
   INTO [ODS].[DBO].[TEM_ARRANGEMENT_ACTIVITY]
  FROM  [TDI].[DBO].[AA_ARRANGEMENT_ACTIVITY] T 
  INNER JOIN [TDI].[DBO].[AA_ACTIVITY_HISTORY_ACTIVITY_REF] A ON T.ARR_SEQUENCE = A.ACTIVITY_REF
  LEFT JOIN [TDI].[DBO].[AA_ARRANGEMENT_ACTIVITY_DATE_TIME] B ON T.SEQ1 = B.SEQ1
  LEFT JOIN [TDI].[DBO].[AA_ARRANGEMENT_ACTIVITY_INPUTTER] C ON T.SEQ1 = B.SEQ1
  WHERE T.CURRENCY = 'CNY';



SELECT [ID]
      ,[COLLECT_ACCOUNT]
      ,[TRUST_ACCOUNT]
      ,[AC_ID]
      ,[AC_TITLE]
      ,[AC_TYPE]
      ,[AC_OPEN_HEAD_BANK]
      ,[AC_OPENING_BANK]
      ,[AC_OPENING_BANK_P]
      ,[AC_OPENING_BANK_C]
      ,[AC_PHONE],
	   CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
  INTO [ODS].[dbo].[TEM_QF_H_COLLECT_AC_PARAM]
  FROM [TDI].[dbo].[QF_H_COLLECT_AC_PARAM]

  

select t.ACCOUNT_NUMBER, t.CUSTOMER_ID, t.AMOUNT_LCY, t.BOOKING_DATE, t.PROCESSING_DATE ,
	    CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME 
  INTO [ODS].[DBO].[TEM_STMT_ENTRY] 
from [tdi].[DBO].[STMT_ENTRY] t 
where t.CURRENCY = 'CNY'



SELECT N.PROPERTY_NAME, N.ENG AS DESCRIPTION_GB, N.CHN AS DESCRIPTION_CN, N.FULL_DESC, N.PROPERTY_CLASS,
       CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME
  INTO [ODS].[DBO].[TEM_AA_PROPERTY_DESC]
  FROM (
  SELECT A.SEQ1,
               A.PROPERTY_NAME,
			   A.PROPERTY_CLASS,
               CASE B.SEQ2
                 WHEN 1 THEN
                  'ENG'
                 ELSE
                  'CHN'
               END AS LAN,
               B.DESCRIPTION,
			   C.FULL_DESC
          FROM [TDI].[DBO].AA_PROPERTY A
		  LEFT JOIN [TDI].[DBO].AA_PROPERTY_DESCRIPTION B ON B.PROPERTY_NAME =A.PROPERTY_NAME
		  LEFT JOIN [TDI].[DBO].AA_PROPERTY_FULL_DESC C ON C.PROPERTY_NAME =A.PROPERTY_NAME 
		  ) M
PIVOT(MAX(DESCRIPTION)
   FOR LAN IN(CHN, ENG)) N



DROP TABLE [ODS].[DBO].[TEM_AA_PAYMENT_SCHEDULE];

SELECT A.CUSTOMER, 
       A.ID, 
       B.TOT_PAYMENT, 
       B.DUE_DATE, 
	   C.DUE_PROPS, 
       C.DUE_PROP_AMT,
       CURRENT_TIMESTAMP AS DW_LAST_UPDATE_TIME
  INTO [ODS].[DBO].[TEM_AA_PAYMENT_SCHEDULE]
  FROM TDI.DBO.QF_AA_PAYMENT_SCHEDULE A
  LEFT JOIN TDI.DBO.QF_AA_PAYMENT_SCHEDULE_DUE_DATE B
    ON A.SEQ1 = B.SEQ1
  LEFT JOIN TDI.DBO.QF_AA_PAYMENT_SCHEDULE_DUE_TYPES C
    ON B.SEQ1 = C.SEQ1
   AND B.SEQ2 = C.SEQ2


